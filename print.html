<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Signway Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="usage.html"><strong aria-hidden="true">2.</strong> Usage</a></li><li class="chapter-item expanded "><a href="openai.html"><strong aria-hidden="true">3.</strong> OpenAI example</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Signway Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-is-signway"><a class="header" href="#what-is-signway">What is Signway?</a></h1>
<p>Signway is a server that proxies authentic pre-signed requests to the specified
destination, adding the appropriate authentication headers if necessary.</p>
<h2 id="what-does-it-do"><a class="header" href="#what-does-it-do">What does it do?</a></h2>
<p>It was initially designed for working with APIs that stream their response, like
<a href="https://platform.openai.com/docs/guides/gpt">OpenAI's ChatGPT API</a>. </p>
<p>The problem starts when the backend that queries
OpenAI's API wants to re-stream the response back to the frontend, sending
the data progressively chunk by chunk as it comes. This can get tricky or 
be even be impossible depending on the backend's stack.</p>
<p>Instead of re-streaming the response from backend to frontend, why not let the
frontend do the request to OpenAI itself? without Signway, the answer is simple:</p>
<p>because OpenAI's key would be leaked.</p>
<p>Signway proposes the following solution:</p>
<ul>
<li>In the backend, instead of querying OpenAI's API, create a pre-signed URL with
a short expiration time.</li>
<li>Send the pre-signed URL back to the frontend.</li>
<li>Let the frontend do the request itself to OpenAI using that pre-signed URL before it
expires.</li>
<li>The request will pass through Signway, who will verify that the signature is 
authentic and has not expired, and if successful, it will proxy the request
to OpenAI's API, adding the authentication header if necessary.</li>
</ul>
<p>With this, the frontend can query OpenAI's API passing through Signway, and it
will be almost like a direct request to OpenAI. </p>
<h2 id="what-can-be-used-for"><a class="header" href="#what-can-be-used-for">What can be used for?</a></h2>
<p>Not only OpenAI's API, but almost any API. Signway is a fast gateway written
in Rust, designed specifically for high throughput, so it can be used for leveraging
any heavy IO task.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-docker"><a class="header" href="#using-docker">Using Docker</a></h1>
<p>Signway is meant to be used with <a href="https://docs.docker.com/engine/install/">Docker</a>, so if
you want to launch Signway locally for testing it, make sure you have it installed in
your machine https://docs.docker.com/engine/install.</p>
<h1 id="running-signway"><a class="header" href="#running-signway">Running Signway</a></h1>
<p>The image is publicly available, so you can run Signway with:</p>
<pre><code class="language-bash">docker run gabotechs/signway &quot;&lt;my-id&gt;&quot; &quot;&lt;my-secret&gt;&quot;
</code></pre>
<p><code>&lt;my-id&gt;</code>: you can choose pretty much whatever you want, as it is meant to
be public, so there is no need for extra security while storing this one.</p>
<p><code>&lt;my-secret&gt;</code>: you want to choose a secure string. Think of this as a password,
you do not want other people to guess it. If you are using Signway in production, 
make sure to store this secret securely, as you will need it for creating URL signatures.</p>
<h1 id="adding-headers-to-the-proxy-ed-request"><a class="header" href="#adding-headers-to-the-proxy-ed-request">Adding headers to the proxy-ed request</a></h1>
<p>Imagine that you want to use Signway with OpenAI's API.</p>
<p>You do not want your users to
see your OpenAI's API key, but if they are the ones making the request through Signway...
then who sets the <code>Authorization: Bearer &lt;openai-token&gt;</code> header?</p>
<p>You can configure Signway to add that header automatically for you:</p>
<pre><code class="language-bash">docker run gabotechs/signway &lt;my-id&gt; &lt;my-secret&gt; \
  --header &quot;Authorization: Bearer &lt;openai-token&gt;&quot;
</code></pre>
<p>Whenever anyone does a request through Signway, and the signature of that request
is authentic, an additional <code>Authorization: Bearer &lt;openai-token&gt;</code> header will be added
to the request.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-signway-with-openais-api"><a class="header" href="#using-signway-with-openais-api">Using Signway with OpenAI's API</a></h1>
<p>This example will use Signway's Python SDK for creating signed URLs, and will use
Signway's docker image for proxying the verified signed requests to OpenAI's api,
so you will need:</p>
<ul>
<li><a href="https://www.python.org/downloads/">Python +3.9</a> or greater installed in you system</li>
<li><a href="https://docs.docker.com/engine/install/">Docker</a> installed in your system</li>
<li>An <a href="https://platform.openai.com/account/api-keys">OpenAI's Api key</a></li>
</ul>
<h2 id="choose-an-id-and-a-secret-for-configuring-signway"><a class="header" href="#choose-an-id-and-a-secret-for-configuring-signway">Choose an <code>id</code> and a <code>secret</code> for configuring Signway</a></h2>
<pre><code class="language-bash">export SW_ID=&quot;app-id&quot;
export SW_SECRET=&quot;super-secure-string&quot;
</code></pre>
<p>You don't need to necessarily use this values, but if you want to just copy-paste those
that's fine.</p>
<p>Don't forget to also export your OpenAI api key, this should be a valid OpenAI key for
this example to work.</p>
<pre><code class="language-bash">export OPENAI_TOKEN=&quot;your valid openai api key goes here&quot;
</code></pre>
<h2 id="launching-the-signway-server"><a class="header" href="#launching-the-signway-server">Launching the Signway server</a></h2>
<p>Open a terminal and launch the Signway server:</p>
<pre><code class="language-bash">docker run -p 3000:3000 gabotechs/signway $SW_ID $SW_SECRET \
 --header &quot;Authorization: Bearer $OPENAI_TOKEN&quot;
</code></pre>
<p>This Signway server will only accept requests correctly signed using <code>$SW_ID</code> and <code>$SW_SECRET</code>.</p>
<h2 id="creating-a-signed-url-using-the-python-sdk"><a class="header" href="#creating-a-signed-url-using-the-python-sdk">Creating a signed URL using the Python SDK</a></h2>
<p>Create a new virtual environment and install the Python SDK:</p>
<pre><code class="language-bash">python3 -m venv venv
source venv/bin/activate
pip install signway-sdk
</code></pre>
<p>Remember to also export here the same <code>id</code> and <code>secret</code> from before:</p>
<pre><code class="language-bash">export SW_ID=&quot;app-id&quot;
export SW_SECRET=&quot;super-secure-string&quot;
</code></pre>
<p>Create a new Python file called <code>sign.py</code> and paste this content:</p>
<pre><code class="language-python"># sign.py
from signway_sdk import sign_url
import os

print(sign_url(
    id=os.environ['SW_ID'],
    secret=os.environ['SW_SECRET'],
    host=&quot;http://localhost:3000&quot;,
    proxy_url=&quot;https://api.openai.com/v1/completions&quot;,
    expiry=10,
    method=&quot;POST&quot;
))
</code></pre>
<p>Executing this script within the <code>venv</code> will output a URL that looks like this:</p>
<pre><code class="language-bash">$ python sign.py

http://localhost:3000/?X-Sw-Algorithm=SW1-HMAC-SHA256&amp;X-Sw-Credential=app-id%2F20230613&amp;X-Sw-Date=20230613T162311Z&amp;X-Sw-Expires=300&amp;X-Sw-Proxy=https%3A%2F%2Fapi.openai.com%2Fv1%2Fchat%2Fcompletions&amp;X-Sw-SignedHeaders=&amp;X-Sw-Body=false&amp;X-Sw-Signature=ebf9dcd8fb2f298af7744a0dbbc96b10d21b38f6e85292f1e06605873088f6e5
</code></pre>
<p>Note that the URL points to your Signway server running in the localhost, but it
has the <code>X-Sw-Proxy</code> query parameter set to <code>https://api.openai.com/v1/completions</code>.
This tells signway where should the request be proxy-ed.</p>
<h2 id="querying-open-ai"><a class="header" href="#querying-open-ai">Querying Open AI</a></h2>
<p>Now, try to make a request with <code>curl</code> as if you wanted to query directly OpenAI's API but
passing through Signway:</p>
<pre><code class="language-bash">curl $(python sign.py) \
-H &quot;Content-Type: application/json&quot; \
-d '{&quot;model&quot;: &quot;text-davinci-003&quot;, &quot;prompt&quot;: &quot;Say this is a test&quot;}'
</code></pre>
<p>If the <code>OPENAI_TOKEN</code> set while launching Signway is valid, you should have received an actual response
from OpenAI, and you didn't need to provide any token in the <code>curl</code> request. Signway added
it for you.</p>
<h2 id="let-the-url-expire"><a class="header" href="#let-the-url-expire">Let the URL expire</a></h2>
<p>Try this now, store the signed URL in an env variable:</p>
<pre><code class="language-bash">export SIGNED_URL=$(python sign.py)
</code></pre>
<p>We configured the script to sign URLs with an expiration date of 10 seconds, so
wait 10 seconds and do the request again:</p>
<pre><code class="language-bash">curl $SIGNED_URL \
-H &quot;Content-Type: application/json&quot; \
-d '{&quot;model&quot;: &quot;text-davinci-003&quot;, &quot;prompt&quot;: &quot;Say this is a test&quot;}'
</code></pre>
<p>If you are quick copy-pasting this commands in a terminal, you may have seen
the request succeed, but after the configured 10s have passed, the request will be rejected.</p>
<h2 id="sign-more-things"><a class="header" href="#sign-more-things">Sign more things</a></h2>
<p>Right now, the <code>Content-Type</code> header and the body are not signed, so consumer of
the signed URL are allowed to do whatever they want with those things.</p>
<p>You can be more restrictive, and also sign both, so that users consuming the signed
URL are forced to pass the headers and the body that you want.</p>
<p>For that, edit the Python script:</p>
<pre><code class="language-python"># sign.py
from signway_sdk import sign_url
import os

print(sign_url(
    id=os.environ['SW_ID'],
    secret=os.environ['SW_SECRET'],
    host=&quot;http://localhost:3000&quot;,
    proxy_url=&quot;https://api.openai.com/v1/completions&quot;,
    expiry=10,
    method=&quot;POST&quot;,
    headers={&quot;Content-Type&quot;: &quot;application/json&quot;},
    body='{&quot;model&quot;: &quot;text-davinci-003&quot;, &quot;prompt&quot;: &quot;Say this is a test&quot;}'
))
</code></pre>
<p>Now, try to make again the request with <code>curl</code>:</p>
<pre><code class="language-bash">curl $(python sign.py) \
-H &quot;Content-Type: application/json&quot; \
-d '{&quot;model&quot;: &quot;text-davinci-003&quot;, &quot;prompt&quot;: &quot;Say this is a test&quot;}'
</code></pre>
<p>That should work, as the provided header and body are the same that were declared in
the signature, but what if the body changes for example?</p>
<pre><code class="language-bash">curl $(python sign.py) \
-H &quot;Content-Type: application/json&quot; \
-d '{&quot;model&quot;: &quot;text-davinci-003&quot;, &quot;prompt&quot;: &quot;Say this is NOT a test&quot;}'
</code></pre>
<p>You will get rejected by Signway, as the body now is contributing to the URL's signature.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
